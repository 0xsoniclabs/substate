# Substate

The **Substate** database is used as an Off-The-Chain testing module in applications for recording or replaying transactions. The **Replayer** can execute any transaction in complete isolation by loading the substate of the transaction and executing it.

The database contains a minimal subset of the **World-State Trie** to faithfully replay transactions in isolation. This subset stores all entries as a flat key-value store (and is not stored as a slow Merkle Patricia Trie) for transaction execution.

## Data Structures

There are 5 data structures stored in the substate DB:

1. **SubstateAccount**: account information (nonce, balance, code, storage)
2. **WorldState**: mapping of account address to **SubstateAccount**
3. **SubstateEnv**: block header information (block gasLimit, number, timestamp, hashes)
4. **SubstateMessage**: message for transaction execution
5. **SubstateResult**: result of transaction execution

To replay transactions and validate results, the following 5 values are required:

1. **PreState**: world-state that is read during transaction execution
2. **Env**: block information required for transaction execution
3. **Message**: an array containing exactly 1 transaction
4. **PostState**: allocation generated by transaction execution
5. **Result**: execution result and a receipt array containing exactly 1 receipt

### Key Format in Substate DB

The first 2 bytes of a key in the substate DB represent different data types as follows:

1. **`1s`**: Substate. The key is `"1s"+N+T`, where `T` is the transaction index at block `N`.
   - Both `T` and `N` are encoded as a big-endian 64-bit binary number.
   
2. **`1c`**: EVM bytecode. The key is `"1c"+codeHash`, where `codeHash` is the Keccak256 hash of the bytecode.

# Ethereum Substate Recorder/Replayer

The Ethereum substate recorder/replayer is based on the paper:

**Yeonsoo Kim, Seongho Jeong, Kamil Jezek, Bernd Burgstaller, and Bernhard Scholz**: _An Off-The-Chain Execution Environment for Scalable Testing and Profiling of Smart Contracts_, USENIX ATC'21

You can find all executables, including `geth` and our `substate-cli`, in the `build/bin/` directory.
